name: Deterministic Proof

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    branches: [master, main]
  push:
    branches: [master, main]

concurrency:
  group: deterministic-proof-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deterministic-proof:
    name: Deterministic setup + notebook proof
    runs-on: [self-hosted]
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4

      - name: Verify required tools
        run: |
          command -v podman
          command -v podman-compose
          command -v conda

      - name: Run canonical deterministic pipeline
        shell: bash
        run: |
          source "$(conda info --base)/etc/profile.d/conda.sh"
          conda activate janusgraph-analysis
          export PODMAN_CONNECTION="${PODMAN_CONNECTION:-podman-wxd-root}"
          bash scripts/deployment/deterministic_setup_and_proof_wrapper.sh \
            --status-report exports/deterministic-status.json

      - name: Assert deterministic status exit_code
        shell: bash
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path

          status = Path('exports/deterministic-status.json')
          if not status.exists():
              raise SystemExit('missing exports/deterministic-status.json')

          payload = json.loads(status.read_text(encoding='utf-8'))
          code = int(payload.get('exit_code', 1))
          if code != 0:
              raise SystemExit(f'deterministic pipeline failed, exit_code={code}')
          print('deterministic status OK')
          PY

      - name: Upload deterministic proof artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deterministic-proof-${{ github.run_id }}
          if-no-files-found: warn
          path: |
            exports/deterministic-status.json
            exports/**/pipeline_summary.txt
            exports/**/notebook_run_report.tsv
            exports/**/determinism.log
            exports/**/manifest.log
            exports/**/services_snapshot.log
            exports/**/runtime_contracts.log
