#!/bin/bash
# Automated Penetration Testing Script for HCD + JanusGraph Platform
# 
# This script runs automated security tests including:
# - Port scanning
# - SSL/TLS testing
# - Container vulnerability scanning
# - Dependency scanning
# - Code security analysis
# - Secrets detection
#
# Usage:
#   ./run_pentest.sh [--quick|--full]

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Determine project root
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
REPORT_DIR="$PROJECT_ROOT/docs/implementation/audits/security/pentest"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
REPORT_FILE="$REPORT_DIR/pentest-report-$TIMESTAMP.md"

# Parse arguments
MODE="full"
if [ "$1" == "--quick" ]; then
    MODE="quick"
fi

# Create report directory
mkdir -p "$REPORT_DIR"

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Automated Penetration Testing${NC}"
echo -e "${GREEN}========================================${NC}"
echo "Mode: $MODE"
echo "Project Root: $PROJECT_ROOT"
echo "Report Directory: $REPORT_DIR"
echo "Timestamp: $TIMESTAMP"
echo ""

# Initialize report
cat > "$REPORT_FILE" << EOF
# Penetration Testing Report

**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
**Mode:** $MODE  
**Tester:** Automated Security Framework  

---

## Executive Summary

This report contains the results of automated penetration testing performed on the HCD + JanusGraph Banking Compliance Platform.

---

## Test Results

EOF

# Function to add section to report
add_section() {
    local title="$1"
    local content="$2"
    echo "" >> "$REPORT_FILE"
    echo "### $title" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "$content" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
}

# Function to check if command exists
command_exists() {
    command -v "$1" &> /dev/null
}

# Test counter
TESTS_RUN=0
TESTS_PASSED=0
TESTS_FAILED=0
TESTS_SKIPPED=0

# 1. Port Scanning
echo -e "${YELLOW}[1/8] Running port scan...${NC}"
if command_exists nmap; then
    TESTS_RUN=$((TESTS_RUN + 1))
    if nmap -sV -sC -p- localhost -oA "$REPORT_DIR/nmap-$TIMESTAMP" > /dev/null 2>&1; then
        echo -e "${GREEN}✓ Port scan completed${NC}"
        TESTS_PASSED=$((TESTS_PASSED + 1))
        
        # Parse results
        OPEN_PORTS=$(grep "open" "$REPORT_DIR/nmap-$TIMESTAMP.nmap" | wc -l)
        add_section "Port Scanning" "**Status:** ✅ PASSED

**Open Ports Found:** $OPEN_PORTS

See detailed results in: \`nmap-$TIMESTAMP.nmap\`

**Analysis:**
- Verify all open ports are necessary
- Ensure management ports (7199, 9042) are not exposed
- Check for unexpected services"
    else
        echo -e "${RED}✗ Port scan failed${NC}"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        add_section "Port Scanning" "**Status:** ❌ FAILED

Port scanning encountered errors. Manual review required."
    fi
else
    echo -e "${YELLOW}⊘ nmap not installed, skipping port scan${NC}"
    TESTS_SKIPPED=$((TESTS_SKIPPED + 1))
    add_section "Port Scanning" "**Status:** ⊘ SKIPPED

nmap not installed. Install with: \`brew install nmap\`"
fi

# 2. SSL/TLS Testing
echo -e "${YELLOW}[2/8] Testing SSL/TLS configuration...${NC}"
if command_exists testssl.sh || command_exists testssl; then
    TESTS_RUN=$((TESTS_RUN + 1))
    TESTSSL_CMD="testssl.sh"
    if ! command_exists testssl.sh; then
        TESTSSL_CMD="testssl"
    fi
    
    if $TESTSSL_CMD --full https://localhost:8182 > "$REPORT_DIR/testssl-$TIMESTAMP.txt" 2>&1; then
        echo -e "${GREEN}✓ SSL/TLS test completed${NC}"
        TESTS_PASSED=$((TESTS_PASSED + 1))
        
        # Check for vulnerabilities
        VULNS=$(grep -i "vulnerable\|not ok\|weak" "$REPORT_DIR/testssl-$TIMESTAMP.txt" | wc -l)
        if [ "$VULNS" -gt 0 ]; then
            add_section "SSL/TLS Testing" "**Status:** ⚠️ WARNINGS

**Potential Issues Found:** $VULNS

See detailed results in: \`testssl-$TIMESTAMP.txt\`

**Action Required:** Review SSL/TLS configuration for weak ciphers or protocols."
        else
            add_section "SSL/TLS Testing" "**Status:** ✅ PASSED

No SSL/TLS vulnerabilities detected.

See detailed results in: \`testssl-$TIMESTAMP.txt\`"
        fi
    else
        echo -e "${RED}✗ SSL/TLS test failed${NC}"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        add_section "SSL/TLS Testing" "**Status:** ❌ FAILED

SSL/TLS testing encountered errors. Service may not be running."
    fi
else
    echo -e "${YELLOW}⊘ testssl.sh not installed, skipping SSL/TLS test${NC}"
    TESTS_SKIPPED=$((TESTS_SKIPPED + 1))
    add_section "SSL/TLS Testing" "**Status:** ⊘ SKIPPED

testssl.sh not installed. Install from: https://testssl.sh/"
fi

# 3. Container Image Scanning
echo -e "${YELLOW}[3/8] Scanning container images...${NC}"
if command_exists trivy; then
    TESTS_RUN=$((TESTS_RUN + 1))
    TOTAL_VULNS=0
    CRITICAL_VULNS=0
    HIGH_VULNS=0
    
    echo "  Scanning images..."
    for image in $(podman images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>" | head -5); do
        echo "    - $image"
        OUTPUT_FILE="$REPORT_DIR/trivy-$(echo $image | tr '/:' '-')-$TIMESTAMP.txt"
        trivy image --severity HIGH,CRITICAL "$image" > "$OUTPUT_FILE" 2>&1 || true
        
        # Count vulnerabilities
        CRITICAL=$(grep -c "CRITICAL" "$OUTPUT_FILE" || true)
        HIGH=$(grep -c "HIGH" "$OUTPUT_FILE" || true)
        CRITICAL_VULNS=$((CRITICAL_VULNS + CRITICAL))
        HIGH_VULNS=$((HIGH_VULNS + HIGH))
        TOTAL_VULNS=$((TOTAL_VULNS + CRITICAL + HIGH))
    done
    
    if [ "$CRITICAL_VULNS" -gt 0 ]; then
        echo -e "${RED}✗ Critical vulnerabilities found in container images${NC}"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        add_section "Container Image Scanning" "**Status:** ❌ FAILED

**Critical Vulnerabilities:** $CRITICAL_VULNS  
**High Vulnerabilities:** $HIGH_VULNS  
**Total:** $TOTAL_VULNS

**Action Required:** Update base images and rebuild containers.

See detailed results in: \`trivy-*.txt\` files"
    elif [ "$HIGH_VULNS" -gt 0 ]; then
        echo -e "${YELLOW}⚠ High vulnerabilities found in container images${NC}"
        TESTS_PASSED=$((TESTS_PASSED + 1))
        add_section "Container Image Scanning" "**Status:** ⚠️ WARNINGS

**High Vulnerabilities:** $HIGH_VULNS

**Recommendation:** Update affected packages.

See detailed results in: \`trivy-*.txt\` files"
    else
        echo -e "${GREEN}✓ No critical/high vulnerabilities in container images${NC}"
        TESTS_PASSED=$((TESTS_PASSED + 1))
        add_section "Container Image Scanning" "**Status:** ✅ PASSED

No HIGH or CRITICAL vulnerabilities found in container images."
    fi
else
    echo -e "${YELLOW}⊘ trivy not installed, skipping container scan${NC}"
    TESTS_SKIPPED=$((TESTS_SKIPPED + 1))
    add_section "Container Image Scanning" "**Status:** ⊘ SKIPPED

trivy not installed. Install with: \`brew install trivy\`"
fi

# 4. Dependency Scanning
echo -e "${YELLOW}[4/8] Scanning Python dependencies...${NC}"
if command_exists uv; then
    TESTS_RUN=$((TESTS_RUN + 1))
    cd "$PROJECT_ROOT"
    
    if uv tool run pip-audit -r requirements.txt > "$REPORT_DIR/pip-audit-$TIMESTAMP.txt" 2>&1; then
        echo -e "${GREEN}✓ No vulnerable dependencies found${NC}"
        TESTS_PASSED=$((TESTS_PASSED + 1))
        add_section "Dependency Scanning" "**Status:** ✅ PASSED

No known vulnerabilities in Python dependencies.

See detailed results in: \`pip-audit-$TIMESTAMP.txt\`"
    else
        VULN_COUNT=$(grep -c "vulnerability" "$REPORT_DIR/pip-audit-$TIMESTAMP.txt" || true)
        if [ "$VULN_COUNT" -gt 0 ]; then
            echo -e "${RED}✗ Vulnerable dependencies found${NC}"
            TESTS_FAILED=$((TESTS_FAILED + 1))
            add_section "Dependency Scanning" "**Status:** ❌ FAILED

**Vulnerabilities Found:** $VULN_COUNT

**Action Required:** Update vulnerable packages.

See detailed results in: \`pip-audit-$TIMESTAMP.txt\`"
        else
            echo -e "${GREEN}✓ Dependency scan completed${NC}"
            TESTS_PASSED=$((TESTS_PASSED + 1))
            add_section "Dependency Scanning" "**Status:** ✅ PASSED

Dependency scan completed successfully."
        fi
    fi
else
    echo -e "${YELLOW}⊘ uv not installed, skipping dependency scan${NC}"
    TESTS_SKIPPED=$((TESTS_SKIPPED + 1))
    add_section "Dependency Scanning" "**Status:** ⊘ SKIPPED

uv not installed. Install from: https://astral.sh/uv"
fi

# 5. Code Security Scan (Bandit)
echo -e "${YELLOW}[5/8] Running code security scan...${NC}"
if command_exists uv; then
    TESTS_RUN=$((TESTS_RUN + 1))
    cd "$PROJECT_ROOT"
    
    if uv tool run bandit -r src/ banking/ -f json -o "$REPORT_DIR/bandit-$TIMESTAMP.json" 2>&1; then
        echo -e "${GREEN}✓ Code security scan completed${NC}"
        
        # Parse results
        HIGH_ISSUES=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' "$REPORT_DIR/bandit-$TIMESTAMP.json" 2>/dev/null || echo "0")
        MEDIUM_ISSUES=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' "$REPORT_DIR/bandit-$TIMESTAMP.json" 2>/dev/null || echo "0")
        
        if [ "$HIGH_ISSUES" -gt 0 ]; then
            echo -e "${RED}✗ High severity security issues found${NC}"
            TESTS_FAILED=$((TESTS_FAILED + 1))
            add_section "Code Security Scan" "**Status:** ❌ FAILED

**High Severity Issues:** $HIGH_ISSUES  
**Medium Severity Issues:** $MEDIUM_ISSUES

**Action Required:** Review and fix high severity issues.

See detailed results in: \`bandit-$TIMESTAMP.json\`"
        else
            TESTS_PASSED=$((TESTS_PASSED + 1))
            add_section "Code Security Scan" "**Status:** ✅ PASSED

**Medium Severity Issues:** $MEDIUM_ISSUES

No high severity security issues found in code.

See detailed results in: \`bandit-$TIMESTAMP.json\`"
        fi
    else
        echo -e "${RED}✗ Code security scan failed${NC}"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        add_section "Code Security Scan" "**Status:** ❌ FAILED

Bandit scan encountered errors."
    fi
else
    echo -e "${YELLOW}⊘ uv not installed, skipping code security scan${NC}"
    TESTS_SKIPPED=$((TESTS_SKIPPED + 1))
    add_section "Code Security Scan" "**Status:** ⊘ SKIPPED

uv not installed."
fi

# 6. Secrets Scanning
echo -e "${YELLOW}[6/8] Scanning for hardcoded secrets...${NC}"
TESTS_RUN=$((TESTS_RUN + 1))
cd "$PROJECT_ROOT"

# Simple grep-based secrets detection
SECRETS_FOUND=0
SECRETS_FILE="$REPORT_DIR/secrets-scan-$TIMESTAMP.txt"

echo "Scanning for potential secrets..." > "$SECRETS_FILE"
grep -r -i -n -E "(password|secret|api_key|token)\s*=\s*['\"][^'\"]{8,}['\"]" \
    src/ banking/ scripts/ 2>/dev/null >> "$SECRETS_FILE" || true

SECRETS_FOUND=$(grep -c "password\|secret\|api_key\|token" "$SECRETS_FILE" || true)

if [ "$SECRETS_FOUND" -gt 1 ]; then  # > 1 because header line
    echo -e "${YELLOW}⚠ Potential secrets found in code${NC}"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    add_section "Secrets Scanning" "**Status:** ⚠️ WARNINGS

**Potential Secrets Found:** $((SECRETS_FOUND - 1))

**Action Required:** Review findings and move secrets to environment variables or Vault.

See detailed results in: \`secrets-scan-$TIMESTAMP.txt\`"
else
    echo -e "${GREEN}✓ No obvious secrets found in code${NC}"
    TESTS_PASSED=$((TESTS_PASSED + 1))
    add_section "Secrets Scanning" "**Status:** ✅ PASSED

No obvious hardcoded secrets detected in code."
fi

# 7. Configuration Security Check
echo -e "${YELLOW}[7/8] Checking configuration security...${NC}"
TESTS_RUN=$((TESTS_RUN + 1))
CONFIG_ISSUES=0

# Check for default passwords in .env files
if [ -f "$PROJECT_ROOT/.env" ]; then
    if grep -i "changeit\|password\|YOUR_\|PLACEHOLDER" "$PROJECT_ROOT/.env" > /dev/null 2>&1; then
        CONFIG_ISSUES=$((CONFIG_ISSUES + 1))
    fi
fi

# Check for debug mode in configs
if grep -r "debug:\s*true\|DEBUG=true" "$PROJECT_ROOT/config" > /dev/null 2>&1; then
    CONFIG_ISSUES=$((CONFIG_ISSUES + 1))
fi

if [ "$CONFIG_ISSUES" -gt 0 ]; then
    echo -e "${RED}✗ Configuration security issues found${NC}"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    add_section "Configuration Security" "**Status:** ❌ FAILED

**Issues Found:** $CONFIG_ISSUES

Potential issues:
- Default passwords in .env files
- Debug mode enabled in production configs

**Action Required:** Review and fix configuration issues."
else
    echo -e "${GREEN}✓ Configuration security check passed${NC}"
    TESTS_PASSED=$((TESTS_PASSED + 1))
    add_section "Configuration Security" "**Status:** ✅ PASSED

No obvious configuration security issues detected."
fi

# 8. File Permissions Check
echo -e "${YELLOW}[8/8] Checking file permissions...${NC}"
TESTS_RUN=$((TESTS_RUN + 1))
PERM_ISSUES=0

# Check sensitive files
for file in .env config/ssl config/vault; do
    if [ -e "$PROJECT_ROOT/$file" ]; then
        PERMS=$(stat -f "%Lp" "$PROJECT_ROOT/$file" 2>/dev/null || stat -c "%a" "$PROJECT_ROOT/$file" 2>/dev/null)
        WORLD_READABLE=$(echo "$PERMS" | cut -c3)
        if [ "$WORLD_READABLE" != "0" ]; then
            PERM_ISSUES=$((PERM_ISSUES + 1))
        fi
    fi
done

if [ "$PERM_ISSUES" -gt 0 ]; then
    echo -e "${YELLOW}⚠ File permission issues found${NC}"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    add_section "File Permissions" "**Status:** ⚠️ WARNINGS

**Issues Found:** $PERM_ISSUES

Some sensitive files have overly permissive permissions.

**Action Required:** Run \`chmod 600\` on sensitive files."
else
    echo -e "${GREEN}✓ File permissions check passed${NC}"
    TESTS_PASSED=$((TESTS_PASSED + 1))
    add_section "File Permissions" "**Status:** ✅ PASSED

File permissions are appropriately restrictive."
fi

# Generate summary
echo "" >> "$REPORT_FILE"
echo "---" >> "$REPORT_FILE"
echo "" >> "$REPORT_FILE"
echo "## Summary" >> "$REPORT_FILE"
echo "" >> "$REPORT_FILE"
echo "**Tests Run:** $TESTS_RUN  " >> "$REPORT_FILE"
echo "**Tests Passed:** $TESTS_PASSED  " >> "$REPORT_FILE"
echo "**Tests Failed:** $TESTS_FAILED  " >> "$REPORT_FILE"
echo "**Tests Skipped:** $TESTS_SKIPPED  " >> "$REPORT_FILE"
echo "" >> "$REPORT_FILE"

if [ "$TESTS_FAILED" -eq 0 ]; then
    echo "**Overall Status:** ✅ PASSED" >> "$REPORT_FILE"
    OVERALL_STATUS="PASSED"
elif [ "$TESTS_FAILED" -le 2 ]; then
    echo "**Overall Status:** ⚠️ NEEDS ATTENTION" >> "$REPORT_FILE"
    OVERALL_STATUS="NEEDS_ATTENTION"
else
    echo "**Overall Status:** ❌ FAILED" >> "$REPORT_FILE"
    OVERALL_STATUS="FAILED"
fi

echo "" >> "$REPORT_FILE"
echo "---" >> "$REPORT_FILE"
echo "" >> "$REPORT_FILE"
echo "**Report Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  " >> "$REPORT_FILE"
echo "**Report Location:** \`$REPORT_FILE\`" >> "$REPORT_FILE"

# Print summary
echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Penetration Testing Complete${NC}"
echo -e "${GREEN}========================================${NC}"
echo "Tests Run: $TESTS_RUN"
echo "Tests Passed: $TESTS_PASSED"
echo "Tests Failed: $TESTS_FAILED"
echo "Tests Skipped: $TESTS_SKIPPED"
echo ""
echo "Overall Status: $OVERALL_STATUS"
echo ""
echo "Report saved to: $REPORT_FILE"
echo ""

# Exit with appropriate code
if [ "$TESTS_FAILED" -gt 0 ]; then
    exit 1
else
    exit 0
fi

# Made with Bob
