#!/usr/bin/env bash
set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
cd "${PROJECT_ROOT}"

if ! command -v uv >/dev/null 2>&1; then
  echo "uv is required" >&2
  exit 1
fi

uv lock

# Canonical runtime lock export
uv export --format requirements-txt --no-hashes > requirements.txt

# Profile-specific lock exports
uv export --format requirements-txt --no-hashes --extra dev > requirements-dev.txt
uv export --format requirements-txt --no-hashes --extra security > requirements-security.txt
uv export --format requirements-txt --no-hashes --extra tracing > requirements-tracing.txt

# Add stable header comments
for f in requirements.txt requirements-dev.txt requirements-security.txt requirements-tracing.txt; do
  tmp="${f}.tmp"
  {
    echo "# AUTOGENERATED FROM uv.lock via scripts/deps/export_locked_requirements.sh"
    echo "# Do not edit by hand. Update pyproject.toml then rerun the exporter."
    cat "${f}"
  } > "${tmp}"
  mv "${tmp}" "${f}"
done

echo "Export complete."
